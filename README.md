# Canvaså®ç°ä»¥é¼ æ ‡å½“å‰ä½ç½®ä¸ºåŸç‚¹ç¼©æ”¾åŠç”»å¸ƒæ‹–åŠ¨ï¼ˆçŸ©é˜µå˜æ¢ï¼‰

## å‰è¨€

åœ¨ä¹‹å‰çš„[Canvasé¼ æ ‡æ»šè½®ç¼©æ”¾ä»¥åŠç”»å¸ƒæ‹–åŠ¨(å›¾æ–‡å¹¶èŒ‚ç‰ˆ)](https://juejin.cn/post/7198767799484563516)ä¸€æ–‡ä¸­æˆ‘æ›¾ç»ä»‹ç»è¿‡ä¸€ç§å®ç°é¼ æ ‡æ»šè½®ç¼©æ”¾åŠç”»å¸ƒæ‹–åŠ¨çš„æ–¹æ³•ï¼Œè¿™ç§æ–¹å¼åˆ©ç”¨çš„æ˜¯Canvasçš„apiè¿›è¡Œç¼©æ”¾å’Œæ‹–åŠ¨ï¼Œå¹¶ä¸”å®ç°åŸç†ç†è§£èµ·æ¥ä¹Ÿæ¯”è¾ƒæŠ½è±¡ã€‚

æœ¬æ–‡å°†ä»‹ç»ä¸€ç§æ›´åŠ ä¾¿æ·ã€é€šç”¨çš„æ–¹å¼æ¥å®ç°é¼ æ ‡æ»šè½®ç¼©æ”¾åŠç”»å¸ƒæ‹–åŠ¨çš„æ–¹å¼ï¼Œè¿™å°±æ˜¯**çŸ©é˜µå˜æ¢**ã€‚

## çŸ©é˜µå˜æ¢

çŸ©é˜µå˜æ¢**å°±æ˜¯ä¸€ç§åæ ‡ç³»çš„è½¬æ¢**ï¼Œå› æ­¤åœ¨å›¾å½¢å­¦ä¸­ï¼Œå°±ä¼šä½¿ç”¨çŸ©é˜µå˜æ¢æ¥è¿›è¡Œå›¾å½¢çš„å˜åŒ–ï¼Œæ¯”å¦‚å¹³ç§»ã€ç¼©æ”¾ã€æ—‹è½¬ã€‚æ¥ä¸‹æ¥æˆ‘ä¼šé‡ç‚¹ä»‹ç»æœ¬æ–‡æ‰€æ¶‰åŠåˆ°çš„å¹³ç§»å’Œç¼©æ”¾å˜æ¢ã€‚

### å¹³ç§»

å‡è®¾æœ‰ä¸€ä¸ªç‚¹ `P(x, y)`ï¼Œå¹³ç§»åˆ°ç‚¹ `P'(x1, y1)`ï¼Œåœ¨æ°´å¹³æ–¹å‘ä½ç§» `dx`ï¼Œå‚ç›´æ–¹å‘çš„ä½ç§» `dy`ï¼Œé‚£ä¹ˆå°±å¯ä»¥å¾—åˆ°å¦‚ä¸‹å…¬å¼ï¼š

$$
x1 = x + dx \\
y1 = y + dy
$$
å¦‚æœå°†ä¸Šè¿°å˜æ¢å…¬å¼è½¬æ¢ä¸ºçŸ©é˜µå˜æ¢çš„å½¢å¼å¯ä»¥å¾—åˆ°å¦‚ä¸‹çŸ©é˜µå˜æ¢å…¬å¼:

$$
\left[
\begin{matrix}
  1 & 0 & dx \\
  0 & 1 & dy \\
  0 & 0 & 1
\end{matrix}
\right]
\left[
\begin{matrix}
  x \\ y \\ 1
\end{matrix}
\right]= \left[
\begin{matrix}
  x+dx \\
  y+dy \\
  1 \\
\end{matrix}
\right]
$$

åœ¨åæ ‡ç³»ä¸­ï¼Œä¸€ä¸ªç‚¹å°±ç›¸å½“äºä¸€ä¸ª**å‘é‡**ï¼Œä» `P` ç‚¹åˆ° `P'` ç‚¹çš„å˜æ¢å¯ä»¥é€šè¿‡:

$$
å˜æ¢çŸ©é˜µ * Pç‚¹ = P'ç‚¹
$$

çš„å½¢å¼æ¥è¡¨è¾¾ã€‚

$$
A = \left[
\begin{matrix}
  1 & 0 & dx \\
  0 & 1 & dy \\
  0 & 0 & 1
\end{matrix}
\right]
$$

AçŸ©é˜µå°±æ˜¯å¹³ç§»çš„å˜æ¢çŸ©é˜µã€‚

### ä¸‰ç»´çŸ©é˜µ

ä¸Šé¢çš„å˜æ¢çŸ©é˜µæˆ‘ä»¬é‡‡ç”¨çš„æ˜¯ä¸€ä¸ªä¸‰ç»´çŸ©é˜µï¼Œå¾ˆå¤šäººåº”è¯¥ä¼šæœ‰ç–‘é—®ï¼š

æ—¢ç„¶æ˜¯è¡¨è¾¾ä¸€ä¸ªäºŒç»´åæ ‡å˜æ¢ï¼Œä¸ºä»€ä¹ˆä¸ç”¨äºŒç»´çŸ©é˜µæ¥è¡¨è¾¾å‘¢ï¼Ÿ

**ç­”æ¡ˆæ˜¯ï¼š** `äºŒç»´çŸ©é˜µæ— æ³•è¡¨è¾¾`ã€‚

ä¸¾ä¸ªä¾‹å­ï¼š

å‡è®¾æˆ‘ä»¬æƒ³æŠŠ `(0, 0)` è¿™ä¸ªç‚¹ç§»åŠ¨åˆ° `(2, 3)`ï¼Œå¦‚æœç”¨äºŒç»´çŸ©é˜µæ¥è¡¨è¾¾ï¼Œæ˜¯è¿™æ ·çš„ï¼š

$$
\left[
\begin{matrix}
  1 & 2 \\
  0 & 3 \\
\end{matrix}
\right]
\left[
\begin{matrix}
  0 \\ 0
\end{matrix}
\right]= \left[
\begin{matrix}
  0 \\
  0 \\
\end{matrix}
\right]
$$

å‘ç°æ— è®ºå¦‚ä½•ä¹Ÿå¾—ä¸åˆ°æˆ‘ä»¬æƒ³åˆ°çš„ç»“æœï¼Œå› ä¸º0ä¸ä»»ä½•æ•°ç›¸ä¹˜éƒ½ä¸º0ã€‚

å¦‚æœæƒ³è¡¨è¾¾äºŒç»´åæ ‡çš„å˜æ¢ï¼Œè‡³å°‘ç”¨ä¸‰ç»´çŸ©é˜µæ¥è¡¨è¾¾ï¼ŒåŒæ ·ï¼Œå¦‚æœåœ¨ä¸‰ç»´åæ ‡ç³»ä¸­(WebGL)ï¼Œé‚£ä¹ˆè‡³å°‘éœ€è¦å››ç»´çŸ©é˜µæ‰èƒ½è¡¨è¾¾ã€‚

## ç¼©æ”¾

å‡è®¾æœ‰ä¸€ä¸ªç‚¹Â `P(x, y)`ï¼Œæ²¿æ°´å¹³æ–¹å‘ç¼©æ”¾ `m` å€ï¼Œæ²¿å‚ç›´æ–¹å‘ç¼©æ”¾ `n` å€ä¹‹åï¼Œå¾—åˆ°ç‚¹Â `P'(x1, y1)`ï¼Œé‚£ä¹ˆå°±å¯ä»¥å¾—åˆ°å¦‚ä¸‹å…¬å¼ï¼š

$$
x1 = x * m \\
y1 = y * n
$$

å¦‚æœå°†ä¸Šè¿°å˜æ¢å…¬å¼è½¬æ¢ä¸ºçŸ©é˜µå˜æ¢çš„å½¢å¼å¯ä»¥å¾—åˆ°å¦‚ä¸‹çŸ©é˜µå˜æ¢å…¬å¼:

$$
\left[
\begin{matrix}
  m & 0 & 0 \\
  0 & n & 0 \\
  0 & 0 & 1
\end{matrix}
\right]
\left[
\begin{matrix}
  x \\ y \\ 1
\end{matrix}
\right]= \left[
\begin{matrix}
  m*x \\
  n*y \\
  1 \\
\end{matrix}
\right]
$$

ä» `P` ç‚¹åˆ° `P'` ç‚¹çš„å˜æ¢å¯ä»¥é€šè¿‡:

$$
å˜æ¢çŸ©é˜µ * Pç‚¹ = P'ç‚¹
$$

çš„å½¢å¼æ¥è¡¨è¾¾ã€‚

$$
A = \left[
\begin{matrix}
  m & 0 & 0 \\
  0 & n & 0 \\
  0 & 0 & 1
\end{matrix}
\right]
$$

AçŸ©é˜µå°±æ˜¯ç¼©æ”¾çš„å˜æ¢çŸ©é˜µã€‚

## å¹³ç§»&ç¼©æ”¾

å‰é¢æˆ‘ä»¬åˆ†åˆ«è®¨è®ºäº†å¹³ç§»å’Œç¼©æ”¾çš„åœºæ™¯ä¸‹ï¼ŒçŸ©é˜µçš„å˜æ¢æ–¹å¼ï¼Œé‚£å¦‚æœæƒ³è¦å®ç°æœ¬æ–‡çš„ç›®æ ‡â€”â€”ä»¥é¼ æ ‡å½“å‰ä½ç½®ä¸ºåŸç‚¹ç¼©æ”¾ï¼Œå°±éœ€è¦åŒæ—¶ç”¨åˆ°å¹³ç§»å’Œç¼©æ”¾å˜æ¢äº†ã€‚

å‡å¦‚ä¸€ä¸ªäºŒç»´åæ ‡ç³»å­˜åœ¨ä¸¤ä¸ªåæ ‡ç‚¹ï¼Œ`A(-2,0)` å’Œ `B(2,0)`ã€‚


![åæ ‡å˜æ¢1.png](./åæ ‡å˜æ¢1.png)

å¦‚æœæ²¿æ°´å¹³æ–¹å‘æ”¾å¤§2å€ï¼Œå³ `A` å’Œ `B` çš„æ°´å¹³åæ ‡å€¼éƒ½ä¹˜ä»¥æ”¾å¤§ç³»æ•°`2`ï¼Œå¾—åˆ°æ–°çš„åæ ‡`A'(-4,0)` å’Œ `B'(4,0)`ã€‚

![åæ ‡å˜æ¢2.png](./åæ ‡å˜æ¢2.png)

å¦‚æœæƒ³è¦ä»¥`B`ç‚¹æ”¾å¤§ä¸­å¿ƒï¼Œç¡®ä¿æ”¾å¤§åçš„`B'`å’Œ`B`ä¿æŒé‡åˆï¼Œéœ€è¦å°†æ”¾å¤§åçš„å›¾å½¢æ•´ä½“å‘å·¦ç§»åŠ¨ä¸€æ®µè·ç¦»ï¼Œè·ç¦»ä¸º `B` å’Œ `Bâ€˜`ä¹‹é—´æ°´å¹³è·ç¦»ï¼Œæ ¹æ®æ•°å­¦å…¬å¼ä¸­ä¸¤ç‚¹ä¹‹é—´çš„è·ç¦»å…¬å¼ï¼Œ`B` å’Œ `Bâ€˜`ä¹‹é—´æ°´å¹³è·ç¦»ä¸º `Bâ€˜` çš„æ°´å¹³åæ ‡å‡å» `B` çš„æ°´å¹³åæ ‡ã€‚

è¿›ä¸€æ­¥æŠ½è±¡è®¡ç®—å…¬å¼ï¼š

å¦‚æœ `B(x,0)`ï¼Œæ²¿æ°´å¹³æ–¹å‘æ”¾å¤§ `n` å€ä¹‹åï¼Œå¾—åˆ° `Bâ€™(n*x,0)`ï¼Œé‚£ä¹ˆä¸¤ç‚¹é—´çš„è·ç¦»ä¸º `n*x-x`ï¼Œåˆå› ä¸ºæ˜¯å‘å·¦ç§»åŠ¨ï¼Œä¸Šè¿°è·ç¦»éœ€è¦å–åï¼Œå³ `x-n*x`ï¼Œæå–å…¬å› å¼ä¹‹åå¾—åˆ°æœ€ç»ˆæ°´å¹³æ–¹å‘çš„åç§»å€¼ä¸º `x(1-n)`ã€‚æ­¤å…¬å¼åŒæ ·é€‚ç”¨äºå‚ç›´æ–¹å‘çš„ç¼©æ”¾ã€‚


![åæ ‡å˜æ¢3.png](./åæ ‡å˜æ¢3.png)

ç†è§£äº†ä»¥æŸä¸€ä¸ªç‚¹è¿›è¡Œç¼©æ”¾çš„åŸç†ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥å¾—åˆ°ä»¥ä¸‹çŸ©é˜µå˜æ¢å…¬å¼ï¼š

$$
\left[
\begin{matrix}
  m & 0 & x(1-m) \\
  0 & m & y(1-m) \\
  0 & 0 & 1
\end{matrix}
\right]
\left[
\begin{matrix}
  x \\ y \\ 1
\end{matrix}
\right]= \left[
\begin{matrix}
  m*x+x(1-m) \\
  m*y+y(1-m) \\
  1 \\
\end{matrix}
\right]
$$

å˜æ¢çŸ©é˜µAå³ä¸ºä»¥æŸä¸€ä¸ªç‚¹è¿›è¡Œç¼©æ”¾çš„å˜æ¢çŸ©é˜µã€‚

$$
A = \left[
\begin{matrix}
  m & 0 & x(1-m) \\
  0 & m & y(1-m) \\
  0 & 0 & 1
\end{matrix}
\right]
$$

## glMatrix

åœ¨çŸ©é˜µå˜æ¢è¿‡ç¨‹ä¸­ä¼šé¢‘ç¹æ¶‰åŠåˆ°çŸ©é˜µçš„ä¸€äº›æ“ä½œï¼Œç‰¹åˆ«æ˜¯çŸ©é˜µçš„ä¹˜æ³•ï¼Œå¯ä»¥ä½¿ç”¨[glMatrix](https://glmatrix.net/)åº“ï¼Œå¸®åŠ©æˆ‘ä»¬ç®€åŒ–çŸ©é˜µçš„è®¡ç®—è¿‡ç¨‹ã€‚

å¦‚æœè®¡ç®—ä¸¤ä¸ªçŸ©é˜µç›¸ä¹˜ï¼š

```js
const out = new Float32Array([
  0, 0, 0,
  0, 0, 0, 
  0, 0, 0,
]);

const o = new Float32Array([
  1, 0, 0,
  0, 1, 0,
  0, 0, 1,
]);

const t = new Float32Array([
  3, 0, 0,
  0, 3, 0,
  0, 0, 3,
]);

const nv = mat3.multiply(out, t, o);
```

ä½¿ç”¨ `glMatrix` åº“è¿›è¡ŒçŸ©é˜µè®¡ç®—çš„æ—¶å€™æœ‰ä¸€ç‚¹è¦æ³¨æ„ï¼š

> This may lead to some confusion when referencing OpenGL documentation, however, which represents out all matricies in column-major format

`glMatrix` æ–‡æ¡£ä¸­å¼ºè°ƒï¼Œ`glMatrix` æ˜¯ä»¥åˆ—ä¸ºä¸»çš„æ ¼å¼ã€‚ä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªçŸ©é˜µï¼Œåœ¨ `glMatrix` ä¸­ä¼šå˜æˆçŸ©é˜µçš„è½¬ç½®è¿›è¡Œè®¡ç®—ã€‚

$$
A=\left[
\begin{matrix}
  1 & 0 & 0 & 0 \\
  0 & 1 & 0 & 0 \\
  0 & 0 & 1 & 0 \\
  x & y & z & 0 \\
\end{matrix}
\right]
$$

åœ¨è¾“å…¥åˆ° glMatrix ä¸­ä¼šè½¬æ¢ä¸º Açš„è½¬ç½®è¿›è¡Œè®¡ç®—ï¼š

$$
A=\left[
\begin{matrix}
  1 & 0 & 0 & x \\
  0 & 1 & 0 & y \\
  0 & 0 & 1 & z \\
  0 & 0 & 0 & 0 \\
\end{matrix}
\right]
$$

## ä»£ç å®ç°

### å®ç°æ‹–æ‹½

`e.movementX` å’Œ `e.movementY` è®°å½•äº†é¼ æ ‡æ°´å¹³æ–¹å‘å’Œå‚ç›´æ–¹å‘ä¸¤æ¬¡ç§»åŠ¨ä¹‹é—´çš„è·ç¦»ã€‚`t` æ˜¯å˜æ¢çŸ©é˜µï¼Œæ³¨æ„è¿™é‡Œçš„çŸ©é˜µ `t` ç”¨ `Float32Array` ç±»å‹è¡¨ç¤ºï¼Œå¹¶ä¸”è¾“å…¥åˆ° `glMatrix` ä¸­å‚ä¸è®¡ç®—æ—¶éœ€è¦å˜ä¸º `t` çš„è½¬ç½®ï¼ˆå‰æ–‡å·²ç»ä»‹ç»ï¼Œ`glMatrix` æ˜¯ä»¥åˆ—ä¸ºä¸»çš„æ ¼å¼ï¼‰ã€‚
```javascript
onMousemove(e) {
  const { movementX, movementY } = e;
  const t = new Float32Array([
    1, 0, 0,
    0, 1, 0,
    movementX, movementY, 1,
  ]);
  this.matrix = this.refresh(this.matrix, t);
}
```

æ¯æ¬¡ç§»åŠ¨ä¹‹åï¼Œè°ƒç”¨ `refresh` æ–¹æ³•ï¼Œåˆ©ç”¨ `glMatrix.mat3.multiply` æ–¹æ³•é‡æ–°è®¡ç®—ç§»åŠ¨ä¹‹åçš„çŸ©é˜µå€¼ï¼Œé€šè¿‡ `ctx.transform` æ–¹æ³•æ¥æ›´æ–°è§†å›¾ã€‚

```javascript
refresh(o, t) {
  const out = new Float32Array([
    0, 0, 0,
    0, 0, 0,
    0, 0, 0,
  ]);
  const calc = glMatrix.mat3.multiply(out, t, o);
  this.ctx.save();
  this.ctx.clearRect(0, 0, this.width, this.height);
  this.ctx.transform(calc[0], calc[3], calc[1], calc[4], calc[6], calc[7]);
  this.draw();
  this.ctx.restore();
  return calc;
}
```

### å®ç°ä»¥é¼ æ ‡å½“å‰ä½ç½®ä¸ºåŸç‚¹ç¼©æ”¾

é¼ æ ‡æ»šè½®äº‹ä»¶è§¦å‘æ—¶ï¼Œé€šè¿‡ event.deltaY å€¼æ¥åˆ¤æ–­æ˜¯æ”¾å¤§è¿˜æ˜¯ç¼©å°ï¼Œæ”¾å¤§è¶…è¿‡æœ€å¤§å€¼æˆ–è€…ç¼©å°ä½äºæœ€å°å€¼æ—¶åˆ™åœæ­¢ç¼©æ”¾ã€‚

ä»¥é¼ æ ‡å½“å‰ä½ç½®ä¸ºåŸç‚¹ç¼©æ”¾çš„å…³é”®æ˜¯åœ¨ç¼©æ”¾çš„åŒæ—¶éœ€è¦è€ƒè™‘åç§»é‡ï¼Œæ°´å¹³æ–¹å‘çš„åç§»é‡ä¸º `clientX * (1 - zoom)`ï¼Œå‚ç›´æ–¹å‘çš„åç§»é‡ä¸º `clientY * (1 - zoom)`ã€‚

```javascript
onMousewheel(e) {
  e.preventDefault();
  const { clientX, clientY, deltaY } = e;
  const zoom = 1 + (deltaY < 0 ? this.scaleStep : -this.scaleStep);
  this.scale = parseFloat((this.scale * zoom).toFixed(2));

  if (this.scale < this.minScale) {
    this.scale = this.minScale;
    return;
  } else if(this.scale > this.maxScale) {
    this.scale = this.maxScale;
    return;
  }

  const x = clientX * (1 - zoom);
  const y = clientY * (1 - zoom);
  const t = new Float32Array([
    zoom, 0, 0,
    0, zoom, 0,
    x, y, 1,
  ]);
  this.matrix = this.refresh(this.matrix, t);
}
```

## æ€»ç»“

é€šè¿‡çŸ©é˜µçš„æ–¹å¼ç”¨ `Canvas` å®ç°ä»¥é¼ æ ‡å½“å‰ä½ç½®ä¸ºåŸç‚¹ç¼©æ”¾åŠç”»å¸ƒæ‹–åŠ¨ï¼Œç†è§£èµ·æ¥æ›´åŠ å®¹æ˜“ï¼ˆå½“ç„¶å‰ææ˜¯è¦æœ‰ä¸€å®šçš„æ•°å­¦åŸºç¡€ï¼Œèµ·ç äº†è§£è¿‡çŸ©é˜µğŸ¤£ï¼‰ï¼Œå¤§å¤§å‡å°‘äº†ä»£ç é‡ï¼ŒåŒæ—¶ç¼©æ”¾å’Œæ‹–æ‹½çš„é€»è¾‘å¯ä»¥å¤ç”¨ï¼Œä¸ä»…æ˜¯åœ¨Canvasä¸­ï¼Œæ™®é€šçš„divæ‹–æ‹½å’Œæ”¾å¤§ä¹Ÿæ˜¯ä¸€æ ·çš„ä»£ç é€»è¾‘ã€‚

æ›´å¤šç²¾å½©æ–‡ç« æ¬¢è¿å¤§å®¶å…³æ³¨æˆ‘çš„vxå…¬ä¼—å·ï¼š**å‰ç«¯æ¶æ„å¸ˆç¬”è®°**ã€‚æœ¬æ–‡å®Œæ•´ä»£ç åœ°å€ï¼šhttps://github.com/astonishqft/canvas-matrix



